services:
  # ======================= Infrastructure Services =======================

  # Zookeeper for Kafka
  zookeeper:
    image: confluentinc/cp-zookeeper:latest
    container_name: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
      KAFKA_HEAP_OPTS: "-Xms64m -Xmx128m"
    ports:
      - "2181:2181"
    networks:
      - social_service_dev_network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: "256M"
        reservations:
          cpus: "0.1"
          memory: "128M"
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "2181"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Kafka Message Broker
  kafka:
    image: confluentinc/cp-kafka:latest
    container_name: kafka
    depends_on:
      zookeeper:
        condition: service_healthy
    ports:
      - "9092:9092"
      - "29092:29092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_HEAP_OPTS: "-Xms256m -Xmx384m"
    networks:
      - social_service_dev_network
    volumes:
      - kafka-data:/bitnami/kafka/data
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: "512M"
        reservations:
          cpus: "0.25"
          memory: "256M"
    healthcheck:
      test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:9092"]
      interval: 10s
      timeout: 10s
      retries: 5

  # Kafka UI for monitoring
  kafka-ui:
    container_name: kafka-ui
    image: provectuslabs/kafka-ui:latest
    ports:
      - "9093:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: local
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:9092
    depends_on:
      - kafka
    networks:
      - social_service_dev_network
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: "256M"
        reservations:
          cpus: "0.1"
          memory: "128M"

  # ======================= ELK Stack =======================

  # Elasticsearch for logging and search
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.13.4
    container_name: elasticsearch
    environment:
      - discovery.type=single-node
      - ELASTICSEARCH_USERNAME=elastic
      - ELASTICSEARCH_PASSWORD=123456
      - ES_JAVA_OPTS=-Xms384m -Xmx512m
      - xpack.security.enabled=false
      - xpack.security.http.ssl.enabled=false
      - bootstrap.memory_lock=false
    ports:
      - "9200:9200"
      - "9300:9300"
    networks:
      - social_service_dev_network
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: "640M"
        reservations:
          cpus: "0.25"
          memory: "384M"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

  # Logstash for log processing
  logstash:
    image: docker.elastic.co/logstash/logstash:8.13.4
    container_name: logstash
    environment:
      - LS_JAVA_OPTS=-Xms128m -Xmx256m
    volumes:
      - ./elk-stack-docker/logstash.conf:/usr/share/logstash/pipeline/logstash.conf
    depends_on:
      elasticsearch:
        condition: service_healthy
    ports:
      - "5044:5044"
      - "5000:5000"
      - "9600:9600"
    networks:
      - social_service_dev_network
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: "384M"
        reservations:
          cpus: "0.1"
          memory: "128M"

  # Kibana for log visualization
  kibana:
    image: docker.elastic.co/kibana/kibana:8.13.4
    container_name: kibana
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
      - xpack.security.enabled=false
      - NODE_OPTIONS="--max-old-space-size=256"
    depends_on:
      elasticsearch:
        condition: service_healthy
    ports:
      - "5601:5601"
    networks:
      - social_service_dev_network
    volumes:
      - kibana_data:/usr/share/kibana/data
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: "512M"
        reservations:
          cpus: "0.1"
          memory: "384M"

  # ======================= Databases =======================

  # Redis
  redis:
      image: redis:latest
      container_name: redis
      command: redis-server --maxmemory 128mb --maxmemory-policy allkeys-lru
      ports:
      - "6379:6379"
      networks:
      - social_service_dev_network
      restart: unless-stopped
      deploy:
        resources:
          limits:
            cpus: "0.25"
            memory: "192M"
          reservations:
            cpus: "0.1"
            memory: "64M"
      healthcheck:
        test: ["CMD", "redis-cli", "ping"]
        interval: 10s
        timeout: 5s
        retries: 5

  # PostgreSQL for auth-service
  auth-db:
    image: postgres:16
    container_name: auth_db
    environment:
      POSTGRES_DB: auth_db
      POSTGRES_USER: osama
      POSTGRES_PASSWORD: 123456
    command: postgres -c shared_buffers=64MB -c effective_cache_size=128MB -c max_connections=30
    ports:
      - "5433:5432"
    networks:
      - social_service_dev_network
    volumes:
      - auth-db-data:/var/lib/postgresql/data
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: "256M"
        reservations:
          cpus: "0.1"
          memory: "128M"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U osama -d auth_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL for main-service
  main-db:
    image: postgres:16
    container_name: main_db
    environment:
      POSTGRES_DB: social_db
      POSTGRES_USER: osama
      POSTGRES_PASSWORD: 123456
    command: postgres -c shared_buffers=128MB -c effective_cache_size=256MB -c max_connections=50
    ports:
      - "5434:5432"
    networks:
      - social_service_dev_network
    volumes:
      - main-db-data:/var/lib/postgresql/data
      - ../services/main-service/docker/init_db.sql:/docker-entrypoint-initdb.d/init_db.sql
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: "384M"
        reservations:
          cpus: "0.25"
          memory: "256M"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U osama -d social_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  #PostgresQL for notification-service
  notification-db:
    image: postgres:16
    container_name: notification_db
    environment:
      POSTGRES_DB: notification_db
      POSTGRES_USER: osama
      POSTGRES_PASSWORD: 123456
    command: postgres -c shared_buffers=64MB -c effective_cache_size=128MB -c max_connections=30
    ports:
      - "5435:5432"
    networks:
      - social_service_dev_network
    volumes:
      - notification-db-data:/var/lib/postgresql/data
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: "256M"
        reservations:
          cpus: "0.1"
          memory: "128M"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U osama -d notification_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  # MongoDB for chat-service
#  chat-db:
#    image: mongo:latest
#    container_name: chat-service-db
#    command: mongod --wiredTigerCacheSizeGB 0.15
#    ports:
#      - "27018:27017"
#    networks:
#      - social_service_dev_network
#    volumes:
#      - chat-service-db-data:/data/db
#    deploy:
#      resources:
#        limits:
#          cpus: "0.25"
#          memory: "256M"
#        reservations:
#          cpus: "0.1"
#          memory: "128M"
#    healthcheck:
#      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
#      interval: 10s
#      timeout: 5s
#      retries: 5

  # ======================= Microservices =======================

  # Discovery Service (Eureka)
  discovery-service:
    image: social-network/discovery-service:latest
    build:
      context: ..
      dockerfile: services/discovery-service/docker/dev/Dockerfile
    container_name: discovery_service
    ports:
      - "8761:8761"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - JAVA_TOOL_OPTIONS=-Xms96m -Xmx192m -XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0
    networks:
      - social_service_dev_network
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: "256M"
        reservations:
          cpus: "0.1"
          memory: "128M"
    healthcheck:
      test: ["CMD-SHELL", "netstat -tulpn | grep :8761 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Auth Service
  auth-service:
    image: social-network/auth-service:latest
    build:
      context: ..
      dockerfile: services/auth-service/Dockerfile
    container_name: auth_service
    ports:
      - "8087:8087"
    env_file:
      - ../.env
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SPRING_DATASOURCE_URL=jdbc:postgresql://auth_db:5432/auth_db
      - SPRING_DATASOURCE_USERNAME=osama
      - SPRING_DATASOURCE_PASSWORD=123456
      - JAVA_TOOL_OPTIONS=-Xms128m -Xmx256m -XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0
    depends_on:
      auth-db:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
    networks:
      - social_service_dev_network
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: "320M"
        reservations:
          cpus: "0.25"
          memory: "192M"
    healthcheck:
      test: ["CMD-SHELL", "netstat -tulpn | grep :8087 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Gateway Service
  gateway-service:
    image: social-network/gateway-service:latest
    build:
      context: ..
      dockerfile: services/gateway-service/docker/dev/Dockerfile
    container_name: gateway_service
    ports:
      - "8081:8081"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - JAVA_TOOL_OPTIONS=-Xms128m -Xmx256m -XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0
    depends_on:
      discovery-service:
        condition: service_healthy
      auth-service:
        condition: service_healthy
    networks:
      - social_service_dev_network
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: "320M"
        reservations:
          cpus: "0.25"
          memory: "192M"

  # Main Service
  main-service:
    image: social-network/main-service:latest
    build:
      context: ..
      dockerfile: services/main-service/docker/dev/Dockerfile
    container_name: main_service
    ports:
      - "8082:8082"
    env_file:
      - ../.env
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SPRING_DATASOURCE_URL=jdbc:postgresql://main-db:5432/social_db
      - SPRING_DATASOURCE_USERNAME=osama
      - SPRING_DATASOURCE_PASSWORD=123456
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - JAVA_TOOL_OPTIONS=-Xms192m -Xmx384m -XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0
    depends_on:
      main-db:
        condition: service_healthy
      kafka:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
      auth-service:
        condition: service_healthy
    networks:
      - social_service_dev_network
    volumes:
      - main-service-uploads:/app/uploads
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: "448M"
        reservations:
          cpus: "0.25"
          memory: "256M"

  # Search Service
  search-service:
    image: social-network/search-service:latest
    build:
      context: ..
      dockerfile: services/search-service/docker/dev/Dockerfile
    container_name: search-service
    ports:
      - "8084:8084"
    env_file:
      - ../.env
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SPRING_ELASTICSEARCH_URIS=http://elasticsearch:9200
      - SPRING_ELASTICSEARCH_USERNAME=elastic
      - SPRING_ELASTICSEARCH_PASSWORD=123456
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - JAVA_TOOL_OPTIONS=-Xms128m -Xmx256m -XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0
    depends_on:
      elasticsearch:
        condition: service_healthy
      kafka:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
      auth-service:
        condition: service_healthy
    networks:
      - social_service_dev_network
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: "320M"
        reservations:
          cpus: "0.25"
          memory: "192M"

  # Notification Service
  notification-service:
    image: social-network/notification-service:latest
    build:
      context: ..
      dockerfile: services/notification-service/docker/dev/Dockerfile
    container_name: notification-service
    ports:
      - "8085:8085"
    env_file:
      - ../.env
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SPRING_DATASOURCE_URL=jdbc:postgresql://notification-db:5432/notification_db
      - SPRING_DATASOURCE_USERNAME=osama
      - SPRING_DATASOURCE_PASSWORD=123456
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - JAVA_TOOL_OPTIONS=-Xms96m -Xmx192m -XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0
    depends_on:
      kafka:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
      auth-service:
        condition: service_healthy
      notification-db:
        condition: service_healthy
    networks:
      - social_service_dev_network
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: "256M"
        reservations:
          cpus: "0.1"
          memory: "128M"

  # Chat Service
  chat-service:
    image: social-network/chat-service:latest
    build:
      context: ..
      dockerfile: services/chat-service/docker/dev/Dockerfile
    container_name: chat-service
    ports:
      - "8086:8086"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SPRING_DATA_MONGODB_HOST=chat-db
      - SPRING_DATA_MONGODB_PORT=27017
      - SPRING_DATA_MONGODB_DATABASE=chat-service
      - SPRING_DATA_REDIS_HOST=redis
      - SPRING_DATA_REDIS_PORT=6379
      - JAVA_TOOL_OPTIONS=-Xms128m -Xmx256m -XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0
    depends_on:
#      chat-db:
#        condition: service_healthy
      redis:
        condition: service_healthy
      discovery-service:
        condition: service_healthy
      auth-service:
        condition: service_healthy
    networks:
      - social_service_dev_network
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: "320M"
        reservations:
          cpus: "0.25"
          memory: "192M"

networks:
  social_service_dev_network:
    driver: bridge

volumes:
  kafka-data:
  elasticsearch_data:
  kibana_data:
  auth-db-data:
  main-db-data:
  chat-service-db-data:
  main-service-uploads:
  notification-db-data:
